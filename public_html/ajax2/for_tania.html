<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script type='text/javascript' src='../js/vendor/jquery-2.1.1.js'></script>
</head>
<body>
<script type="text/javascript">
    var arr_data = [];
    arr_data['day'] = []; //
    arr_data['week'] = [];
    arr_data['month'] = [];

    function parseSomeTypeData(data, type) {
        for(var i in data) {
            var id = data[i].id;
            if (arr_data[type][id] == undefined) {
                arr_data[type][id] = {
                    values: {
                        production: [],
                        consumption: []
                    },
                    date: []
                };
            }
            for(var j in data[i].values) {
                arr_data[type][id].date.push(data[i].values[j][0]);
                arr_data[type][id].values.production.push(data[i].values[j][1]);
                arr_data[type][id].values.consumption.push(data[i].values[j][2]);
            }
        }
    }

    function parseData(data) {
        data = data.data;
        parseSomeTypeData(data.day, 'day');
        parseSomeTypeData(data.week, 'week');
        parseSomeTypeData(data.month, 'month');
    }

    function getProduction(type, ids) {
        var data = arr_data[type];
        if (data == 'undefined') return null;
        var result = [];
        for(var i in ids) {
            result.push(data[ids[i]].values.production);
        }
        return result;
    }

    function getConsumption(type, ids) {
        var data = arr_data[type];
        if (data == 'undefined') return null;
        var result = [];
        for(var i in ids) {
            result.push(data[ids[i]].values.consumption);
        }
        return result;
    }

    function getDate(type, ids) {
        var data = arr_data[type];
        if (data == 'undefined') return null;
        if (typeof ids == 'object') {
            if (ids.length != 0)
                return data[ids[0]].date;
            else
                return null;
        } else {
            return data[ids].date;
        }
    }

    function funcError(message) {
        alert("ERROR: " + message);
    }

    function checkExistsUser(id) {
        return arr_data['day'][id] != undefined; //будь-який тип, т.к дані приходять одночасно
    }

    function getValues(ids, funcSuccess, funcError) {
        $.ajax({
            url: 'http://rdam.zz.mu/ajax2/users_values.php?id=' + ids +'&todt=last',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response) {
                    funcSuccess(response);
                } else {
                    funcError('');
                }
            },
            error: function(xhr, status, error) {
                var err = JSON.parse(xhr.responseText);
                funcError(err.error_message);
            }
        });
    }

    //приклад використання

    getValues('1', parseData, funcError);

    setTimeout(afterFirstRequest, 5000); // змоделюємо ситуацію вручну

    function afterFirstRequest() {
        if(checkExistsUser(1)) {
            console.log(JSON.stringify(arr_data['day'][1]));
            getValues('2,3,4', parseData, funcError);
            setTimeout(afterSecondRequest, 7000);
        } else {
            console.log('id = 1 not exists'); // мабуть 1-ий запит викликав помилку або 5 сек. було мало.
        }
    }

    function afterSecondRequest() {
        $('#p').text(getProduction('day', [1,2,3,4]).join(', '));
        $('#c').text(getConsumption('day', [1,2,3,4]).join(', '));
        $('#d').text(getDate('day', [1,2,3,4]).join(', '));
    }


</script>
<div id="wait">wait...</div>
<div id="v">
    <div id="p"></div>
    <div id="c"></div>
    <div id="d"></div>
</div>
</body>
</html>